

# 修復システム：断面マッチング計画

## ゴール
バラバラになった土器（**自作した簡易モデル `Lathe_Pot`**）の破片から、互いに一致する「断面（破断面）」を自動的に特定し、可視化するシステムを構築する。
※スキャンモデルは複雑すぎたため、検証用としてシンプルなこのモデルを使用する。

## 課題
破片には「元の土器の表面（外側・内側）」と「割れてできた断面」が混在している。
1.  **断面の特定**: どれが割れた面なのか？
2.  **マッチング**: どの面とどの面がくっつくのか？
3.  **可視化**: 結果をどうやってユーザーに見せるか？

## アルゴリズム案

### フェーズ 1: データ抽出（Blender Python）
*   **対象**: RBDLabで生成された全ての「Shard（破片）」オブジェクト。
*   **フィルタリング**: **マテリアル（素材）** を使って断面を特定する。
    *   RBDLabは断面に `Inner_Material` などの特別なマテリアルを割り当てる。
    *   このマテリアルが割り当てられた「面（Face）」のメッシュデータだけを抽出する。

### フェーズ 2: 断面の特徴化（指紋採取）
各破片の断面ごとの「島（アイランド）」に対して、以下の情報を計算する：
1.  **面積 (Area)**: その断面の広さ。
    *   *一致条件*: ほぼ同じ面積であること（誤差 ±5%以内など）。

### 3.2 断面の細分化 (V6: Majority-Vote & Smoothing)
幾何学的に繋がっている断面（島）を、隣接する破片IDに基づいてさらに分割し、1対1のマッチングを保証します。
1.  **初期ラベリング**: 各断面ポリゴンから他破片への最近接探索を行い、最も近い破片IDを仮ラベルとする。
2.  **多数決平滑化 (Majority-Vote)**: 各ポリゴンの周囲のラベルを確認し、多数決で自身のラベルを更新するイテレーション（5回程度）を実行。これにより計算誤差によるノイズを除去する。
3.  **島分けの再実行**: 「物理的に繋がっている」かつ「ラベル（隣接相手）が同じ」面を1つの最終的なファセット（断面ユニット）として統合。
- **結果**: ノイズのない、数学的に整合した1対1ペアの自動生成を実現。
2.  **法線ベクトル (Normal)**: 面の向いている方向。
    *   *一致条件*: くっつく時、お互いが向き合っていること（逆ベクトル）。
3.  **形状ハッシュ (Vertex Signature)**:
    *   頂点の配置パターン（点群の距離など）を使って、形の類似度を計算する。

### フェーズ 3: マッチングロジック
1.  破片A (`Shard_A`) を選ぶ。
2.  他の全ての破片 (`Shard_B`, `Shard_C`...) と比較する。
3.  「指紋」を照合する。
4.  スコアが高い（面積が同じで形が似ている）ペアが見つかったら、それを「ペア候補」として記録する。

### フェーズ 4: 可視化
*   **ライン描画**: 一致した断面の中心同士を 3D空間上で「線」で結ぶ。
*   **色分け**: ペアになった破片を同じ色にする。
*   **自動修復（オプション）**: 破片Bを破片Aの位置にスナップさせて元に戻す。

## ロードマップ
1.  - [x] ステップ1: 断面認識スクリプト (幾何学的分割)
- [/] ステップ2: 隣接関係に基づく断面再分割 (1対1ペア作成)
*   Pythonで「断面（Inner Materialの面）」だけを選択・ハイライトできるかテストする。
2.  **ステップ2: 特徴量計算**
    *   各断面の「面積」と「中心座標」を計算してログに出す。
3.  **ステップ3: 単純マッチング（面積ベース）**
    *   まずは「面積が同じ」だけでペアを探し、線を引いてみる。
4.  **ステップ4: 高度マッチング（形状ベース）**
    *   面積だけでは区別できない場合（正方形など）の精度を上げる。

## 技術要件
*   Blender Python API (`bpy`, `bmesh`)
*   `mathutils` (ベクトル計算用)
